<html>
<head>
  <meta charset="utf-8">
  <title>NetsBlox Client Tests</title>
</head>
<body style="margin: 0;">
  <iframe id="user1" style="width:100%;height:100%;"></iframe>
  <!-- Add the testing things -->

  <script src="/test/lib/jquery-2.2.4.min.js"></script>
  <script src="/test/lib/expect.min.js"></script>
  <script src="../snap-driver.js"></script>
  <script src="./netsblox-gremlins.js"></script>

  <script type="text/javascript" >
      const frames = Array.prototype.slice.call(document.getElementsByTagName('iframe'));
      var driver = null;
      var horde = null;
      frames.forEach(frame => {
        frame.setAttribute('src', window.origin);
      });
      function startTests() {
          let loaded = 0;
          return frames
              .reduce((promise, frame) => {
                  return promise.then(() => {
                      const id = frame.getAttribute('id');
                      driver = new SnapDriver(frame.contentWindow.world);
                      driver.setWindow(frame.contentWindow);
                      return;// driver.login('test');
                  });
              }, Promise.resolve())
              .then(() => {
                horde = gremlins.createHorde();

                // Add all available gremlin types
                gremlinFunctions.forEach(f => {
                    horde.gremlin(f);
                });

                // Use distribution to shape output
                horde.strategy(gremlins.strategies.distribution()
                    .delay(100) // 50 ms delay
                    .distribution(getGremlinDistribution()) // distribution defined in other file
                );

                horde.unleash();
            });
      }

      function checkLoaded() {
          const allLoaded = frames.reduce((isLoaded, frame) => {
              const id = frame.getAttribute('id');
              return isLoaded && !!frame.contentWindow.world;
          }, true);

          if (allLoaded) {
              startTests();
          } else {
              setTimeout(checkLoaded, 10);
          }
      }
      window.onload = checkLoaded;

      /* Uncomment the following to add a console log at the start of each test
        var oit = it;
        it = function(desc, test) {
            if (test.length) {
                return oit.call(this, desc, function(done) {
                    console.log('starting test:', desc);
                    return test(done);
                });
            } else {
                return oit.call(this, desc, function() {
                    console.log('starting test:', desc);
                    return test();
                });
            }
        };
      */
  </script>
  <script src="./gremlins.min.js"></script>

</body>
</html>
