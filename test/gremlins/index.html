<html>
<head>
  <meta charset="utf-8">
  <title>NetsBlox Client Tests</title>
</head>
<body style="margin: 0;">
  <iframe id="user1" style="width:100%;height:100%;"></iframe>
  <!-- Add the testing things -->

  <script src="/test/lib/jquery-2.2.4.min.js"></script>
  <script src="/test/lib/expect.min.js"></script>
  <script src="../snap-driver.js"></script>

  <script type="text/javascript" >
      const frames = Array.prototype.slice.call(document.getElementsByTagName('iframe'));
      var driver = null;
      var horde = null;
      frames.forEach(frame => {
        frame.setAttribute('src', window.origin);
      });
      function startTests() {
          let loaded = 0;
          return frames
              .reduce((promise, frame) => {
                  return promise.then(() => {
                      const id = frame.getAttribute('id');
                      driver = new SnapDriver(frame.contentWindow.world);
                      driver.setWindow(frame.contentWindow);
                      return;// driver.login('test');
                  });
              }, Promise.resolve())
              .then(() => {
                horde = gremlins.createHorde()
                    .gremlin(function() {
                        let categoryNames = driver.getCategoryNames();
                        driver.selectCategory(categoryNames[Math.floor(Math.random() * categoryNames.length)]);
                    })
                    .gremlin(function() {
                        let newName = "";
                        let newLength = Math.random() * 20;

                        for (let i = 0; i < newLength; i++) {
                            newName += String.fromCharCode("0x" + Math.floor(Math.random() * 65503 + 32).toString(16));
                        }

                        driver.setProjectName(newName);
                        driver.selectTab('scripts');
                    });
                horde.unleash();
            });
      }

      function checkLoaded() {
          const allLoaded = frames.reduce((isLoaded, frame) => {
              const id = frame.getAttribute('id');
              return isLoaded && !!frame.contentWindow.world;
          }, true);

          if (allLoaded) {
              startTests();
          } else {
              setTimeout(checkLoaded, 10);
          }
      }
      window.onload = checkLoaded;

      /* Uncomment the following to add a console log at the start of each test
        var oit = it;
        it = function(desc, test) {
            if (test.length) {
                return oit.call(this, desc, function(done) {
                    console.log('starting test:', desc);
                    return test(done);
                });
            } else {
                return oit.call(this, desc, function() {
                    console.log('starting test:', desc);
                    return test();
                });
            }
        };
      */
  </script>
  <script src="../replay.spec.js"></script>
  <script src="../room.spec.js"></script>
  <script src="../save.spec.js"></script>
  <script src="../messages.spec.js"></script>
  <script src="../blocks.spec.js"></script>
  <script src="../actions.spec.js"></script>
  <script src="../accounts.spec.js"></script>
  <script src="../ide.spec.js"></script>
  <script src="../variables.spec.js"></script>
  <script src="../sprites.spec.js"></script>
  <script src="../xml.spec.js"></script>
  <script src="../url.spec.js"></script>
  <script src="../cloud.spec.js"></script>
  <script src="./gremlins.min.js"></script>

</body>
</html>
